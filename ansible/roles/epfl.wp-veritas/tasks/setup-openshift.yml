- name: wp-veritas Deployment
  openshift:
    state: latest
    apiVersion: extensions/v1beta1
    kind: Deployment
    metadata:
      annotations:
        image.openshift.io/triggers: "{{ [ _trigger ] | to_json }}"
      labels:
        app: wp-veritas
      name: wp-veritas
      namespace: "{{ openshift_namespace }}"
    spec:
      replicas: >-
        {{ 2 if openshift_namespace == "wwp" else 1 }}
      selector:
        matchLabels:
          app: wp-veritas
      template:
        metadata:
          labels:
            app: wp-veritas
        spec:
          containers:
          - name: meteor
            image: "{{ _existing_image if _existing_image != None
                       else wp_veritas_image_tag }}"
            env:
            - name: WP_VERITAS_AWX_URL
              value: "{{ twelvefactor[inventory_environment].WP_VERITAS_AWX_URL }}"
            - name: ROOT_URL
              value: "{{ twelvefactor[inventory_environment].ROOT_URL }}"
            - name: DEBUG
              value: >-
                {{ "-" if inventory_environment == "prod" else "*" }}
            - name: PORT
              value: "3000"
            envFrom:
            - secretRef:
                name: wp-veritas
            imagePullPolicy: Always
            ports:
            - containerPort: 3000
              protocol: TCP
  vars:
    _trigger:
      fieldPath: 'spec.template.spec.containers[?(@.name=="meteor")].image'
      from:
        kind: ImageStreamTag
        name: >-
          wp-veritas:{{ "prod" if openshift_namespace == "wwp" else "latest" }}
    _existing_deployment: >-
      {{ query('kubernetes.core.k8s', kind="Deployment",
      namespace=openshift_namespace, resource_name="wp-veritas") }}
    _existing_image: >-
      {{ _existing_deployment[0].spec.template.spec.containers[0].image | default(None) }}
